<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zama FHE Terminal - Fully Homomorphic Encryption (FHE) Secure Auction</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background-color: #000000; color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 5px; text-shadow: 0 0 5px #00ff00, 0 0 15px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }

        /* --- Product Layout Styles --- */
        .product-layout { 
            background-color: #050505; 
            border: 2px solid #ffff00; 
            padding: 25px; 
            margin-bottom: 30px; 
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.4); 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
        }
        .product-layout h2 {
            font-size: 2em;
            color: #ffff00;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .product-details {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .product-image-container {
            flex-shrink: 0;
            width: 200px;
            height: 150px;
            background: #111;
            border: 1px solid #00ff00;
            overflow: hidden;
            position: relative;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7; 
        }
        .product-info {
            flex-grow: 1;
            line-height: 1.4;
        }
        .product-info p {
            margin-bottom: 8px;
        }
        .product-info strong {
            color: #00ff00;
        }
        /* --- End Product Layout Styles --- */

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background-color: #000000; border: 2px solid #00ff00; padding: 25px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); animation: fadeInUp 1s ease-out; }
        .card h2 { margin-bottom: 20px; font-size: 1.8em; color: #ffff00; border-bottom: 1px dashed #00ff00; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #00ff00; background: #000; color: #00ff00; font-size: 1em; font-family: 'VT323', monospace; margin-bottom: 15px; caret-color: #ffff00; box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); transition: border-color 0.2s; }
        input:focus { outline: none; border-color: #ffff00; box-shadow: 0 0 8px #ffff00; }
        button { background: #000; border: 2px solid #00ff00; padding: 12px 20px; color: #00ff00; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s ease; font-family: 'VT323', monospace; letter-spacing: 1px; text-transform: uppercase; }
        button:hover { background: #00ff00; color: #000000; box-shadow: 0 0 15px #00ff00; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #000; color: #00ff00; box-shadow: none; }
        .auction-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #0a0a0a; padding: 15px; border: 1px solid #00ff00; text-align: center; }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.5em; font-weight: bold; color: #ffff00; }
        .wallet-status { padding: 15px; background: #0a0a0a; border: 1px dashed #00ff00; margin-bottom: 20px; text-align: left; }
        .fhe-badge { display: inline-block; background: #00ff00; color: #000; padding: 3px 8px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; border: 1px solid #00ff00; box-shadow: 0 0 5px #00ff00; }
        .encrypted-badge { display: flex; align-items: center; gap: 10px; background: #111; padding: 10px; border: 1px solid #00ff00; margin-top: 10px; }
        .encrypted-badge::before { content: "üîí"; font-size: 1.2em; filter: drop-shadow(0 0 3px #00ff00); }
        .tx-monitor { grid-column: 1 / -1; }
        .tx-container { height: 300px; background: #0a0a0a; border: 1px solid #00ff00; overflow-y: auto; padding: 10px; line-height: 1.4; white-space: pre-wrap; position: relative; }
        .tx-container::-webkit-scrollbar { width: 8px; }
        .tx-container::-webkit-scrollbar-thumb { background: #00ff00; }
        .tx-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .log-line { opacity: 0; animation: fadeIn 0.5s ease-out forwards; padding: 2px 0; }
        .log-time { color: #ffff00; margin-right: 10px; }
        .log-pending { color: orange; }
        .log-confirmed { color: #00ff00; }
        .log-failed { color: #ff0000; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { transform: translateY(0); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #000; border: 2px solid; box-shadow: 0 0 10px; animation: slideInRight 0.4s ease; z-index: 1000; font-family: 'VT323', monospace; }
        .notification.success { border-color: #00ff00; box-shadow-color: rgba(0, 255, 0, 0.7); color: #00ff00; }
        .notification.error { border-color: #ff0000; box-shadow-color: rgba(255, 0, 0, 0.7); color: #ff0000; }
        .notification.info { border-color: #ffff00; box-shadow-color: rgba(255, 255, 0, 0.7); color: #ffff00; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .loading { display: inline-block; width: 1em; height: 1em; border: 0.15em solid rgba(0, 255, 0, 0.3); border-radius: 50%; border-top-color: #00ff00; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reveal-btn { background: #ff0000; color: #fff; border-color: #ff0000; }
        .reveal-btn:hover { background: #ff5555; box-shadow: 0 0 15px #ff0000; }
        @media (min-width: 768px) { .main-grid { grid-template-columns: 2fr 3fr; } .tx-monitor { grid-column: 1 / 3; } .product-details { flex-direction: row; } }
        @media (max-width: 767px) { .product-details { flex-direction: column; } .product-image-container { width: 100%; height: 200px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>[SYSTEM ONLINE] ZAMA FHE AUCTION $</h1>
            <p class="subtitle">Fully Homomorphic Encryption (FHE) Secure Auction - Sepolia Testnet Ready.</p>
        </header>

        <div class="product-layout">
            <h2>&gt; AUCTION ITEM: **CRYPTIC KEY**</h2>
            <div class="product-details">
                <div class="product-image-container">
                    <img id="productImage" class="product-image" src="https://raw.githubusercontent.com/Quangx199x/SYSTEM-ONLINE---ZAMA-FHE-AUCTION/refs/heads/main/key.jpeg" alt="S·∫£n ph·∫©m ƒë·∫•u gi√°">
                </div>
                <div class="product-info">
                    <p><strong>Description:</strong> Encrypted Golden Key. This item is the unique NFT token, granting access to a secret on-chain contract, with an estimated market value of 20 ETH.**.</p>
                    <p><strong>Starting price:</strong> 0.001 ETH.</p>
                    <p><strong>Conditions: The bid is encrypted (euint64 - Gwei) and must surpass all competitors. The winning funds will be transferred to the Beneficiary after decryption.</p>
                </div>
            </div>
        </div>
        <div class="main-grid">
            <div class="card wallet-section">
                <h2>> INIT WALLET SERVICE & FHE SDK</h2>
                <div class="wallet-status" id="walletStatus">
                    <p class="log-line log-info">[STATUS] Wallet: DISCONNECTED</p>
                    <p class="log-line log-info">[INFO] Target Network: **Sepolia (11155111)**</p>
                    <p class="log-line log-pending" id="fheStatus">[FHE SDK] Initializing FHE WASM files...</p>
                </div>
                <button id="connectBtn">
                    &gt; CONNECT & CHECK NETWORK
                </button>
            </div>

            <div class="card">
                <h2>> AUCTION DATA FEED (FHE PROTECTED)</h2>
                <div class="auction-info">
                    <div class="info-item">
                        <div class="info-label">Current Bid (Encrypted)</div>
                        <div class="info-value" id="currentBid">CIPHERTEXT</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lead Bidder</div>
                        <div class="info-value" id="leadBidder">0x0000...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Min Bid Deposit</div>
                        <div class="info-value" id="minDepositValue">-- ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time Remaining</div>
                        <div class="info-value" id="timeLeft">--:--:--</div>
                    </div>
                </div>
                <button id="finalizeBtn" class="reveal-btn" disabled style="display: none;">
                    &gt; REQUEST FINALIZE (OWNER ONLY)
                </button>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>> FHE BID SUBMISSION</h2>
                <label for="bidAmount" class="log-line">[INPUT] Enter Amount (ETH) - Deposit:</label>
                <input 
                    type="number" 
                    id="bidAmount" 
                    placeholder="ETH value (must meet min deposit)" 
                    step="0.001"
                    min="0"
                >
                <div class="encrypted-badge">
                    <span>Use @zama-fhe/relayer-sdk to encrypt euint64 (Gwei) and generate client-side proof.</span>
                </div>
                <button id="bidBtn" disabled>
                    &gt; SUBMIT ENCRYPTED BID $ (Sepolia)
                </button>
            </div>
            
            <div class="card tx-monitor">
                <h2>> LIVE TRANSACTION LOG <span class="fhe-badge">FHEVM</span></h2>
                <div class="tx-container" id="txContainer">
                    <p class="log-line" style="animation-delay: 0.1s;"><span class="log-time">[00:00:00]</span> [CORE] System initialization complete. Awaiting wallet connection on Sepolia...</p>
                    <p class="log-line" style="animation-delay: 0.2s;"><span class="log-time">[00:00:01]</span> [FHE] Loading Zama SDK and Sepolia configuration...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs"></script> 

	<script defer>
    // --- ZAMA FHE SDK & CONFIGURATION ---
    
    // **!!! REPLACE THIS WITH YOUR FHE Auction CONTRACT ADDRESS!!!**
    const CONTRACT_ADDRESS = '0x76044483b2387720EA449243Eb3d1eE1f5c86fbE'; 
    
    // ABI gi·ªØ nguy√™n (ƒë·∫ßy ƒë·ªß t·ª´ code c≈©)
    const FHE_AUCTION_ABI = [/* Paste full ABI t·ª´ code c≈© ·ªü ƒë√¢y */];  // Gi·ªØ nguy√™n

    const SEPOLIA_CHAIN_ID = 11155111; 
    // **FIX: Thay RPC v·ªÅ Zama FHEVM (h·ªó tr·ª£ precompiles)**
    const SEPOLIA_RPC = 'https://devnet.zama.ai/fhevm';  // Zama RPC cho FHE ops
    const EIP712_DOMAIN_NAME = "FHEAuction";
    const EIP712_DOMAIN_VERSION = "1";
    
    // Tr·∫°ng th√°i chung (gi·ªØ nguy√™n)
    let provider;
    let signer;
    let account;
    let fheAuctionContract;
    let fhevmInstance = null; 
    let timerInterval; 
    let minDepositWei; 
    let auctionEndTime = 0; 
    let contractOwner = null; 
    
    // --- UTILITY FUNCTIONS --- (Gi·ªØ nguy√™n: formatLogTime, logMessage, showNotification, updateActionButtons, startAuctionTimer)
    // Paste t·ª´ code c≈©...

    // --- FHE SDK INITIALIZATION --- (Th√™m retry cho RPC fail)
    async function initFhevmSdk(retryCount = 0) {
        const fheStatus = document.getElementById('fheStatus');
        const maxRetries = 3;

        try {
            fheStatus.textContent = '[FHE SDK] Loading SDK (v0.2.0 ESM CDN)...';
            const mod = await import('https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js');
            const { initSDK, createInstance, SepoliaConfig } = mod;

            fheStatus.textContent = '[FHE SDK] Initializing WASM (initSDK)...';
            await initSDK(); 

            fheStatus.textContent = '[FHE SDK] Creating FHE instance...';

            const baseConfig = { ...SepoliaConfig, network: SEPOLIA_RPC, chainId: SEPOLIA_CHAIN_ID };

            let sdkInstance = null;
            try {
                sdkInstance = await createInstance(baseConfig);
            } catch (err) {
                logMessage(`[FHE] Base config failed: ${err.message}. Trying manual...`, 'pending');
                // Fallback to manual config
                const manualConfig = {
                    aclContractAddress: '0x687820221192C5B662b25367F70076A37bc79b6c',
                    kmsContractAddress: '0x1364cBBf2DF5032C47d8226a6f6FBD2AFCDacAC',
                    inputVerifierContractAddress: '0xbc91f3daD1A5F19F8390c400196e58073B6a0BC4',
                    verifyingContractAddressDecryption: '0xb6E160B1ff80D67Bfe90A85eE06Ce0A2613607D1',
                    verifyingContractAddressInputVerification: '0x7048C39f048125eDa9d678AEbaDfB22F7900a29F',
                    chainId: SEPOLIA_CHAIN_ID,
                    gatewayChainId: 55815,
                    network: SEPOLIA_RPC,  // S·ª≠ d·ª•ng Zama RPC
                    relayerUrl: 'https://relayer.testnet.zama.cloud',
                };
                sdkInstance = await createInstance(manualConfig);
            }

            fheStatus.textContent = '[FHE SDK] Public Key loaded. Ready for encryption.';
            fheStatus.className = 'log-line log-confirmed';
            logMessage('[FHE] SDK initialized successfully with Zama RPC. Client-side encryption enabled.', 'confirmed');
            return sdkInstance;

        } catch (error) {
            console.error("FHE SDK Initialization failed:", error);
            fheStatus.textContent = '[FHE SDK] FAILED. Check Relayer status or retry.';
            fheStatus.className = 'log-line log-failed';
            logMessage(`[FATAL] FHE SDK Failed: ${error.message || error}. Retry ${retryCount + 1}/${maxRetries}?`, 'failed');
            
            if (retryCount < maxRetries) {
                setTimeout(() => initFhevmSdk(retryCount + 1), 5000);  // Retry sau 5s
            }
            throw new Error("FHE SDK failed. Cannot proceed without fix.");
        }
    }

    // --- CONTRACT STATE & EVENTS --- (Gi·ªØ nguy√™n: getAuctionState, listenToEvents)

    // --- WALLET & CONNECTION --- (Th√™m log RPC)
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            showNotification('ERROR: MetaMask not detected.', 'error');
            return;
        }

        try {
            logMessage('[PROMPT] Requesting connection and network switch to Sepolia (Zama RPC)...', 'info');
            logMessage(`[RPC] Using FHEVM RPC: ${SEPOLIA_RPC}`, 'info');  // Log RPC ƒë·ªÉ debug
            
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: `0x${SEPOLIA_CHAIN_ID.toString(16)}` }],
            });

            provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();

            if (network.chainId !== SEPOLIA_CHAIN_ID) {
                throw new Error("Wrong network. Please switch to Sepolia FHEVM.");
            }

            signer = provider.getSigner();
            account = await signer.getAddress();
            
            fhevmInstance = await initFhevmSdk();  // G·ªçi v·ªõi retry

            fheAuctionContract = new ethers.Contract(
                CONTRACT_ADDRESS, 
                FHE_AUCTION_ABI, 
                signer 
            );
            
            await getAuctionState();
            listenToEvents();

            document.getElementById('walletStatus').innerHTML = `
                <p class="log-line log-confirmed">[STATUS] Wallet: CONNECTED & READY</p>
                <p class="log-line">[ADDRESS] ${account.substring(0, 10)}... ${account.toLowerCase() === contractOwner.toLowerCase() ? '(OWNER)' : ''}</p>
                <p class="log-line">[NETWORK] **Sepolia FHEVM (Zama RPC)**</p>
            `;

            document.getElementById('connectBtn').textContent = '> CONNECTION ESTABLISHED (Sepolia)';
            document.getElementById('connectBtn').disabled = true;
            
            showNotification('Connected to Sepolia FHEVM. Interface ready.', 'success');
            logMessage('[SUCCESS] Wallet, Network, and Contract OK with Zama RPC. Ready to bid/finalize.', 'confirmed');
            startAuctionTimer();

            const finalized = await fheAuctionContract.isAuctionFinalized();
            updateActionButtons(auctionEndTime, finalized, contractOwner); 

            window.ethereum.on('accountsChanged', () => { window.location.reload(); });
            window.ethereum.on('chainChanged', () => { window.location.reload(); });

        } catch (error) {
            console.error(error);
            const msg = error.message.includes('User rejected') ? 'User rejected connection/switch.' : error.message;
            showNotification('Connection Failed: ' + msg, 'error');
            logMessage(`[ERROR] Connection failed: ${msg} (Check RPC: ${SEPOLIA_RPC})`, 'failed');
            document.getElementById('bidBtn').disabled = true;
        }
    }

    // --- BIDDING LOGIC & FINALIZATION --- (Gi·ªØ nguy√™n placeBid v√† requestFinalizeAuction t·ª´ code c≈©, ho·∫∑c th√™m pre-check n·∫øu c·∫ßn)

    // --- EVENT LISTENERS INITIALIZATION --- (Gi·ªØ nguy√™n)
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('bidBtn').addEventListener('click', placeBid);
        document.getElementById('finalizeBtn').addEventListener('click', requestFinalizeAuction); 
    });

</script>
   
</body>
</html>
